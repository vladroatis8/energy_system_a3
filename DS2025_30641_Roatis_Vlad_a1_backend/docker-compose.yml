version: '3.8'

services:
  
  traefik:
    image: traefik:v2.10
    container_name: traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8080:8080"   # Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - auth-service
      - user-service
      - device-service
      - frontend         
    labels:
      - "traefik.enable=true"

      # ðŸ”¹ Frontend
      - "traefik.http.routers.frontend.rule=PathPrefix(`/`)"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"
      - "traefik.http.routers.frontend.entrypoints=web"

      # ðŸ”¹ Auth service
      - "traefik.http.routers.auth.rule=PathPrefix(`/auth`)"
      - "traefik.http.services.auth.loadbalancer.server.port=8080"
      - "traefik.http.routers.auth.entrypoints=web"
      - "traefik.http.routers.auth-swagger.rule=PathPrefix(`/auth/swagger-ui`, `/auth/v3/api-docs`)"
      # ðŸ”¹ User service
      - "traefik.http.routers.user.rule=PathPrefix(`/users`)"
      - "traefik.http.services.user.loadbalancer.server.port=8080"
      - "traefik.http.routers.user.entrypoints=web"

      # ðŸ”¹ Device service
      - "traefik.http.routers.device.rule=PathPrefix(`/devices`)"
      - "traefik.http.services.device.loadbalancer.server.port=8080"
      - "traefik.http.routers.device.entrypoints=web"
      # WebSocket support
      - "traefik.http.routers.websocket.rule=PathPrefix(`/ws`)"
      - "traefik.http.services.websocket.loadbalancer.server.port=8085"
      - "traefik.http.routers.websocket.entrypoints=web"

    networks:
      - app-network

  
  # bd pt useri
  user-postgres-db:
    image: postgres:13
    container_name: user_postgres_db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 1234
      POSTGRES_DB: user_db
    volumes:
      - user-db-data:/var/lib/postgresql/data
    networks:
      - app-network 

  
  user-service:
    build: ./user-service 
    depends_on:
      - user-postgres-db 
      - auth-service

    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://user-postgres-db:5432/user_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: 1234
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.user-service.rule=PathPrefix(`/users`)"
      - "traefik.http.services.user-service.loadbalancer.server.port=8080"
    networks:
      - app-network

  # db pt device uri
  device-postgres-db:
    image: postgres:13
    container_name: device_postgres_db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 1234
      POSTGRES_DB: device_db
    volumes:
      - device-db-data:/var/lib/postgresql/data
    networks:
      - app-network

 
  device-service:
    build: ./device-service
    depends_on:
      - device-postgres-db
      - rabbitmq
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://device-postgres-db:5432/device_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: 1234 
      SERVER_PORT: 8080 
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.device-service.rule=PathPrefix(`/devices`)"
      - "traefik.http.services.device-service.loadbalancer.server.port=8080"
    ports:
      - "8082:8082"
    networks:
      - app-network

  auth-postgres-db:
    image: postgres:13
    container_name: auth_postgres_db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 1234
      POSTGRES_DB: auth_db 
    volumes:
      - auth-db-data:/var/lib/postgresql/data 
    networks:
      - app-network

  auth-service:
    build: ./auth-service 
    depends_on:
      - auth-postgres-db 
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://auth-postgres-db:5432/auth_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: 1234
      JWT_SECRET: ${JWT_SECRET} 
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.auth-service.rule=PathPrefix(`/auth`)"
      - "traefik.http.services.auth-service.loadbalancer.server.port=8080"
    networks:
      - app-network

  frontend:
    build: ../DS2025_30641_Roatis_Vlad_a1_frontend/frontend
    container_name: frontend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=PathPrefix(`/`)"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"
    networks:
      - app-network
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "15672:15672"  # UI
      - "5672:5672"    # broker
    networks:
      - app-network
  monitoring-postgres-db:
    image: postgres:15
    container_name: monitoring_postgres_db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 1234
      POSTGRES_DB: monitoring_db
    volumes:
      - monitoring-db-data:/var/lib/postgresql/data
    networks:
      - app-network
  monitoring-service:
    build: ./monitoring-service
    container_name: monitoring-service
    depends_on:
      - monitoring-postgres-db
      - rabbitmq
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://monitoring-postgres-db:5432/monitoring_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: 1234

      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.monitoring.rule=PathPrefix(`/api/consumption`)"
      - "traefik.http.services.monitoring.loadbalancer.server.port=8084"
    networks:
      - app-network

  websocket-service:
    build: ./websocket-service
    container_name: websocket-service
    depends_on:
      - rabbitmq
    environment:
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.websocket-service.rule=PathPrefix(`/ws`)"
      - "traefik.http.services.websocket-service.loadbalancer.server.port=8085"
    ports:
      - "8085:8085"
    networks:
      - app-network

networks:
  app-network:  
    driver: bridge

volumes:
  user-db-data:
  device-db-data:
  auth-db-data:
  monitoring-db-data:
